<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>FOODdrugs â€“ Lebensmittel-Medikament-Interaktionen</title>

    <!-- PWA + Icons -->
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" sizes="16x16" href="icons/icon-16.png">
    <link rel="icon" type="image/png" sizes="32x32" href="icons/icon-32.png">
    <link rel="apple-touch-icon" href="icons/icon-192.png">
    <meta name="theme-color" content="#0A84FF">

    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
            background: #f2f2f7;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
        }

        .container {
            width: 100%;
            max-width: 600px;
            padding: 30px 20px 60px;
        }

        h1 {
            margin: 0;
            font-size: 32px;
            font-weight: 700;
            color: #1c1c1e;
            text-align: center;
        }

        .subtitle {
            margin-top: 6px;
            margin-bottom: 25px;
            color: #6e6e73;
            font-size: 15px;
            text-align: center;
        }

        .card {
            background: #ffffff;
            padding: 22px;
            border-radius: 18px;
            box-shadow: 0 8px 28px rgba(0,0,0,0.08);
            margin-bottom: 25px;
            border: 1px solid rgba(0,0,0,0.05);
        }

        label {
            font-weight: 600;
            margin-top: 12px;
            display: block;
            color: #1c1c1e;
            font-size: 15px;
        }

        input {
            width: 100%;
            padding: 14px;
            margin-top: 8px;
            margin-bottom: 18px;
            border-radius: 12px;
            border: 1px solid #d1d1d6;
            font-size: 17px;
            background: #fafafa;
            transition: 0.2s;
        }

        input:focus {
            border-color: #0a84ff;
            background: #ffffff;
            outline: none;
            box-shadow: 0 0 0 4px rgba(10,132,255,0.15);
        }

        button {
            width: 100%;
            padding: 16px;
            background: #0a84ff;
            color: white;
            border: none;
            border-radius: 14px;
            font-size: 18px;
            cursor: pointer;
            font-weight: 600;
            transition: 0.2s;
        }

        button:hover {
            background: #006edc;
        }

        button:active {
            transform: scale(0.98);
        }

        #result h2 {
            margin-top: 0;
            font-size: 22px;
            font-weight: 700;
            color: #1c1c1e;
        }

        .result-icon {
            font-size: 30px;
            margin-right: 10px;
        }

        .severity-hoch {
            border-left: 12px solid #ff3b30;
            background: #fff2f2;
        }

        .severity-mittel {
            border-left: 12px solid #ff9500;
            background: #fff7e6;
        }

        .severity-niedrig {
            border-left: 12px solid #34c759;
            background: #f1fff4;
        }

        .severity-unbekannt {
            border-left: 12px solid #8e8e93;
            background: #f4f4f7;
        }

        .hidden {
            display: none;
        }

        ul.autocomplete-list {
            position: absolute;
            background: #ffffff;
            border: 1px solid #d1d1d6;
            list-style: none;
            padding: 0;
            margin: 0;
            width: calc(100% - 50px);
            max-height: 180px;
            overflow-y: auto;
            z-index: 1000;
            border-radius: 14px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.12);
        }

        ul.autocomplete-list li {
            padding: 14px;
            cursor: pointer;
            color: #1c1c1e;
            font-size: 16px;
        }

        ul.autocomplete-list li:hover {
            background: #f2f2f7;
        }

        .status {
            font-size: 13px;
            color: #6e6e73;
            text-align: center;
            margin-bottom: 10px;
        }
    </style>
</head>

<body>

<div class="container">

    <h1>FOODdrugs</h1>
    <p class="subtitle">Lebensmittelâ€“Medikamentâ€“Interaktionen (voll offline)</p>
    <p id="status" class="status">Lade Datenbankâ€¦</p>

    <div class="card">
        <label>Lebensmittel</label>
        <input id="foodInput" type="text" placeholder="z.B. Grapefruit">

        <label>Medikament</label>
        <input id="drugInput" type="text" placeholder="z.B. Atorvastatin">

        <button onclick="checkInteraction()">Interaktion prÃ¼fen</button>
    </div>

    <div id="result" class="card hidden"></div>

</div>

<script>
// -----------------------------
// Lokale Datenbank laden
// -----------------------------
let interactions = null;

async function loadInteractions() {
    if (interactions) return interactions;
    try {
        const res = await fetch("interactions.json");
        interactions = await res.json();
        document.getElementById("status").textContent = "Datenbank geladen â€“ App ist offline nutzbar.";
    } catch (e) {
        console.error("Fehler beim Laden von interactions.json:", e);
        document.getElementById("status").textContent = "Fehler beim Laden der Datenbank.";
        interactions = {};
    }
    return interactions;
}

// Aliase auflÃ¶sen (wie im Backend)
function resolveDrugKey(inputDrug) {
    if (!interactions) return null;
    const input = inputDrug.toLowerCase();
    for (const key of Object.keys(interactions)) {
        const aliases = interactions[key]._aliases || [];
        if (aliases.map(a => a.toLowerCase()).includes(input)) {
            return key;
        }
    }
    return null;
}

// -----------------------------
// Autocomplete
// -----------------------------
function setupAutocomplete(inputId, fetchFunction) {
    const input = document.getElementById(inputId);
    const list = document.createElement("ul");
    list.className = "autocomplete-list";
    list.style.display = "none";
    input.parentNode.appendChild(list);

    input.addEventListener("input", async () => {
        const value = input.value.trim().toLowerCase();
        list.innerHTML = "";

        if (!value) {
            list.style.display = "none";
            return;
        }

        const suggestions = await fetchFunction(value);
        const matches = suggestions.filter(item => item.toLowerCase().includes(value));

        matches.forEach(match => {
            const item = document.createElement("li");
            item.textContent = match;
            item.addEventListener("click", () => {
                input.value = match;
                list.style.display = "none";
            });
            list.appendChild(item);
        });

        list.style.display = matches.length ? "block" : "none";
    });

    document.addEventListener("click", (e) => {
        if (e.target !== input) {
            list.style.display = "none";
        }
    });
}

async function fetchMedications() {
    const data = await loadInteractions();
    return Object.keys(data);
}

async function fetchFoods() {
    await loadInteractions();
    const drug = document.getElementById("drugInput").value.trim();
    if (!drug) return [];
    const drugKey = resolveDrugKey(drug) || drug;
    if (!interactions[drugKey]) return [];
    return Object.keys(interactions[drugKey]).filter(k => k !== "_aliases");
}

// Autocomplete aktivieren
setupAutocomplete("drugInput", fetchMedications);
setupAutocomplete("foodInput", fetchFoods);

// -----------------------------
// Interaktion prÃ¼fen â€“ komplett lokal
// -----------------------------
async function checkInteraction() {
    const food = document.getElementById("foodInput").value.trim();
    const drug = document.getElementById("drugInput").value.trim();
    const resultBox = document.getElementById("result");

    if (!food || !drug) {
        resultBox.innerHTML = "<b>Bitte Lebensmittel und Medikament eingeben.</b>";
        resultBox.className = "card";
        resultBox.classList.remove("hidden");
        return;
    }

    await loadInteractions();

    const drugKey = resolveDrugKey(drug) || drug.toLowerCase();
    const foodKey = food.toLowerCase();

    let data;

    if (
        drugKey &&
        interactions[drugKey] &&
        interactions[drugKey][foodKey] &&
        foodKey !== "_aliases"
    ) {
        const info = interactions[drugKey][foodKey];
        data = {
            source: "kuratiert",
            drug,
            food,
            severity: info.severity,
            effect: info.effect,
            mechanism: info.mechanism,
            recommendation: info.recommendation
        };
    } else {
        data = {
            source: "offline",
            drug,
            food,
            severity: "unbekannt",
            effect: "In der lokalen Datenbank wurde keine Interaktion zu dieser Kombination gefunden.",
            mechanism: "",
            recommendation: "Bei Unsicherheit bitte Ã¤rztlichen oder pharmazeutischen Rat einholen."
        };
    }

    const severityKey = (data.severity || "unbekannt").toLowerCase();
    const severityClass = "severity-" + severityKey;

    let icon = "âšª";
    if (severityKey === "hoch") icon = "ðŸ”´";
    if (severityKey === "mittel") icon = "ðŸŸ ";
    if (severityKey === "niedrig") icon = "ðŸŸ¢";

    resultBox.className = "card " + severityClass;

    resultBox.innerHTML = `
        <h2><span class="result-icon">${icon}</span>Ergebnis</h2>
        <p><b>Lebensmittel:</b> ${data.food}</p>
        <p><b>Medikament:</b> ${data.drug}</p>
        <p><b>Schweregrad:</b> ${data.severity || "unbekannt"}</p>
        <p><b>Wirkung:</b> ${data.effect || "Keine Angaben verfÃ¼gbar."}</p>
        <p><b>Mechanismus:</b> ${data.mechanism || "Keine Angabe"}</p>
        <p><b>Empfehlung:</b> ${data.recommendation || "Bei Unsicherheit bitte medizinischen Rat einholen."}</p>
        <p><i>Quelle: ${
            data.source === "kuratiert"
                ? "Kuratierte Offline-Datenbank"
                : data.source === "offline"
                ? "Lokaler Offline-Modus"
                : "Unbekannt"
        }</i></p>
    `;

    resultBox.classList.remove("hidden");
}

// Initiale Daten laden
loadInteractions();
</script>

<script>
if ("serviceWorker" in navigator) {
  window.addEventListener("load", () => {
    navigator.serviceWorker.register("service-worker.js")
      .then(reg => console.log("Service Worker registriert:", reg))
      .catch(err => console.error("Service Worker Fehler:", err));
  });
}
</script>

</body>
</html>




